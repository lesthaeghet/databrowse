<xsl:template xmlns:dir="http://thermal.cnde.iastate.edu/databrowse/dir" match="dir:dir" mode="detailed">
    <xsl:call-template name="directorytree">
        <xsl:with-param name="mode">detailed</xsl:with-param>
    </xsl:call-template>
</xsl:template>
<xsl:template xmlns:dir="http://thermal.cnde.iastate.edu/databrowse/dir" match="dir:dir" mode="summary">
    <xsl:call-template name="directorytree">
        <xsl:with-param name="mode">summary</xsl:with-param>
    </xsl:call-template>
</xsl:template>
<xsl:template xmlns:dir="http://thermal.cnde.iastate.edu/databrowse/dir" match="dir:dir" mode="title">
    <xsl:call-template name="directorytree">
        <xsl:with-param name="mode">title</xsl:with-param>
    </xsl:call-template>
</xsl:template>
<xsl:template xmlns:dir="http://thermal.cnde.iastate.edu/databrowse/dir" name="directorytree">
    <xsl:param name="mode"/>
    <xsl:if test="@root='True' and not(@ajaxreq='True')">
        <script>
            <xsl:attribute name="src"><xsl:value-of select="@resurl"/>/jquery-1.9.1.min.js</xsl:attribute>
        </script>
        <script type="text/javascript">
                $(document).ready(function() {
                    $.ImgToggle = function(img, resurl) {
                        if($(img).attr("src") == resurl + "/icons/folder-open.png") {
                            $(img).attr("src", resurl + "/icons/folder.png");
                        }
                        else {
                            $(img).attr("src", resurl + "/icons/folder-open.png");
                        }
                    };
                    $.AjaxRequest = function(id, img, requrl, resurl) {
                        if($(img).attr("src") == resurl + "/icons/folder-open.png"){
                            $(img).attr("src", resurl + "/icons/folder.png");
                        }
                        else if($(id).html() != "") { 
                            $(img).attr("src", resurl + "/icons/folder-open.png");
                        }
                        else {
                            $.ajax({
                                url: requrl,
                                beforeSend: function ( xhr ) {
                                    xhr.overrideMimeType("text/plain; charset=x-user-defined");
                                    $(img).attr("src", resurl + "/icons/loading.gif");
                                }
                            }).done(function ( data ) {
                                obj = $('&lt;html /&gt;').html(data);
                                text = $('ul.rootdir',obj).html();
                                $(id).html(text);
                                $(img).attr("src", resurl + "/icons/folder-open.png");
                            });
                        }
                    };
                }); 
        </script>
        <style>
                ul.tree, ul.tree ul {
                    list-style-type: none;
                    margin: 0px;
                    padding: 0 0px;
                    background: url('<xsl:value-of select="@resurl"/>/vline.png') repeat-y;
                }
                .item {
                    margin: 0px;
                    padding: 0 18px;
                    line-height:20px;
                    background: url('<xsl:value-of select="@resurl"/>/node.png'), url('<xsl:value-of select="@resurl"/>/vline.png');
                    background-repeat: no-repeat, repeat-y;
                }
                ul.tree li:last-child{
                    background: #fff url('<xsl:value-of select="@resurl"/>/lastnode.png') no-repeat;
                }
                ul.root {
                    margin: 0px;
                    padding: 0px;
                    list-style-type: none;
                    margin-bottom: 0px;
                    background: none;
                }
                ul.tree ul.rootdir {
                    padding: 0 0px;
                }                
                li.subdir {
                    margin: 0px;
                    padding: 0 0px;
                    line-height:20px;
                    background: #fff none;
                }
                ul.tree li.subdir {
                    background: #fff none;
                }                
                .icon {
                    float: left;
                    display: block;
                    width: 18px;
                    height: 18px;
                }
                .title {
                    font-weight: bold;
                }
                ul.tree li.rootdir {
                    background: #fff none;
                }
        </style>
    </xsl:if>

    <xsl:choose>
         <xsl:when test="@root='True'">
            <ul class="tree root" id="tree">
                <xsl:call-template name="treestructure">
                    <xsl:with-param name="mode"><xsl:value-of select="$mode"/></xsl:with-param>
                </xsl:call-template>
            </ul>
         </xsl:when>
         <xsl:otherwise>
            <ul class="tree root">
                <xsl:call-template name="treestructure">
                    <xsl:with-param name="mode"><xsl:value-of select="$mode"/></xsl:with-param>
                </xsl:call-template>
            </ul>
         </xsl:otherwise>
    </xsl:choose>
</xsl:template>
<xsl:template xmlns:dir="http://thermal.cnde.iastate.edu/databrowse/dir" name="treestructure">
    <xsl:param name="mode"/>
    <li>
        <xsl:choose>
            <xsl:when test="@root='True'">
                <xsl:attribute name="class">rootdir</xsl:attribute>
                <div class="icon">
                    <img id="img{generate-id(.)}">
                        <xsl:attribute name="alt"><xsl:value-of select="@path"/></xsl:attribute>
                        <xsl:attribute name="title"><xsl:value-of select="@path"/></xsl:attribute>
                        <xsl:attribute name="src"><xsl:value-of select="@resurl"/>/icons/folder-visiting.png</xsl:attribute>
                    </img>
                </div>
                <div class="title">
                    <xsl:value-of select="@path"/>&#160;
                    <a>
                        <xsl:attribute name="href"><xsl:value-of select="@uphref"/></xsl:attribute>
                        <img alt="Up" title="Go Up One Directory Level">
                            <xsl:attribute name="src"><xsl:value-of select="@resurl"/>/icons/up.png</xsl:attribute>
                        </img>
                    </a>
                </div>
            </xsl:when>
            <xsl:when test="@ajax='True'">
                <xsl:attribute name="class">subdir</xsl:attribute>
                <div class="icon">
                    <img id="img{generate-id(.)}" onclick="$(&apos;#{generate-id(.)}&apos;).toggle();$.AjaxRequest(&apos;#{generate-id(.)}&apos;,&apos;#img{generate-id(.)}&apos;,&apos;{@ajaxurl}&apos;,&apos;{@resurl}&apos;);">
                        <xsl:attribute name="alt"><xsl:value-of select="@path"/></xsl:attribute>
                        <xsl:attribute name="title"><xsl:value-of select="@path"/></xsl:attribute>
                        <xsl:attribute name="src"><xsl:value-of select="@resurl"/>/icons/folder.png</xsl:attribute>
                    </img>
                </div>
                <div class="title">
                    <a>
                        <xsl:attribute name="href"><xsl:value-of select="@href"/></xsl:attribute>
                        <xsl:value-of select="@name"/>
                    </a>
                </div>
            </xsl:when>
            <xsl:otherwise>
                <xsl:attribute name="class">subdir</xsl:attribute>
                <div class="icon">
                    <img id="img{generate-id(.)}" onclick="$(&apos;#{generate-id(.)}&apos;).toggle();$.ImgToggle(&apos;#img{generate-id(.)}&apos;,&apos;{@resurl}&apos;);">
                        <xsl:attribute name="alt"><xsl:value-of select="@path"/></xsl:attribute>
                        <xsl:attribute name="title"><xsl:value-of select="@path"/></xsl:attribute>
                        <xsl:attribute name="src"><xsl:value-of select="@resurl"/>/icons/folder.png</xsl:attribute>
                    </img>
                </div>
                <div class="title">
                    <a>
                        <xsl:attribute name="href"><xsl:value-of select="@href"/></xsl:attribute>
                        <xsl:value-of select="@name"/>
                    </a>
                </div>
            </xsl:otherwise>
        </xsl:choose>
        <ul id="{generate-id(.)}">
            <xsl:choose>
                <xsl:when test="@root='True'">
                    <xsl:attribute name="class">rootdir</xsl:attribute>
                </xsl:when>
                <xsl:otherwise>
                    <xsl:attribute name="class">subdir</xsl:attribute>
                    <xsl:attribute name="style">display:none</xsl:attribute>
                </xsl:otherwise>
            </xsl:choose>
            <xsl:for-each select="dir:file">
                <li class="item">
                    <xsl:choose>
                        <xsl:when test="$mode='title'">
                            <xsl:apply-templates select="." mode="title"/>
                        </xsl:when>
                        <xsl:when test="$mode='summary'">
                            <xsl:apply-templates select="." mode="summary"/>
                        </xsl:when>
                        <xsl:when test="$mode='detailed'">
                            <xsl:apply-templates select="." mode="detailed"/>
                        </xsl:when>
                    </xsl:choose>          
                </li>
            </xsl:for-each>
        </ul>
    </li>
</xsl:template>